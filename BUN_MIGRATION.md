# Bun-native migration notes

This document records the steps taken to migrate the build to Bun and how to reproduce it locally.

## Goals
- Use Bun's native bundler (`bun build`) to produce:
  - `dist/esm/index.js` (ESM entry)
  - `dist/kalman-filter.min.js` (IIFE UMD-style for browser use)
- Keep TypeScript declarations generated by `tsc` (`cjs/index.d.ts`)
- Keep existing tests and CI intact for now; optionally migrate tests later

## Commands
- Install with Bun:
  - bun install

- Build everything (types + bundles):
  - npm run build
  - Or using Bun directly (recommended):
    - bun run build:all
    - or bun run build:types && bun build index.ts --outfile=dist/esm/index.js --format=esm --minify --sourcemap && bun build index.ts --outfile=dist/kalman-filter.min.js --format=iife --global-name=kalmanFilter --minify --sourcemap

- Quick Bun-only build:
  - bun build index.ts --outfile=dist/esm/index.js --format=esm --minify --sourcemap
  - bun build index.ts --outfile=dist/kalman-filter.min.js --format=iife --global-name=kalmanFilter --minify --sourcemap

## Notes / Caveats
- `bun build` requires Bun installed on your machine.
- Type declaration files are still produced by `tsc` (run `bun x tsc -p tsconfig.json`).
- Tests & scripts are invoked with Bun: `bun run test` runs `bun x tsc`, `bun x xo`, and `bun x ava`.
- CI: add a job that runs `bun install` and `bun run build` on tags to produce `dist/` artifacts for releases.

## Rollback
If upstream moves away from Bun or if you prefer to use the original Webpack toolchain again:
- Restore previous build scripts to use `webpack` and `ts-loader`.
- Re-add any CI steps that used `webpack`.

## CI: auto-build and commit dist (this repo)
A GitHub Actions workflow has been added at `.github/workflows/build-and-commit.yml`.

Behavior:
- Runs on pushes to `master`, and on tags matching `v*.*.*` (semantic tags), and can be triggered manually.
- Installs with Bun, runs tests (`npm test`) and runs the `npm run build` task (which runs TypeScript types + Bun builds).
- If any of the tracked files (`dist/`, `cjs/`, `index.mjs`, `package.json`, `BUN_MIGRATION.md`) change, the action will commit them back to the repository with the message `chore(build): add dist artifacts [skip ci]`.

Notes:
- The workflow uses the `GITHUB_TOKEN` so no further secrets are required for pushing the commit.
- The workflow includes a guard `if: github.actor != 'github-actions'` to avoid infinite loops when the action itself commits back to the repo.

## Versioning & Releases
- Recommended: add a release step that uploads the `dist/*` artifacts to the GitHub release. The workflow is focused on committing artifacts to the default branch so that installs from GitHub work without needing a build step on the consumer side.

---
